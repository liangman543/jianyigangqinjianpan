<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€æ˜“é’¢ç´é”®ç›˜</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --window-bg: #1e293b;
            --header-bg: #334155;
            --header-bg-dragging: #4f46e5;
            --text-color: #f1f5f9;
            --white-key: #ffffff;
            --white-key-active: #cbd5e1;
            --black-key: #000000;
            --black-key-active: #374151;
            --border-color: #475569;
        }

        * {
            box-sizing: border-box;
            user-select: none; /* ç¦æ­¢é€‰ä¸­æ–‡æœ¬ï¼Œä¿è¯æ‹–æ‹½ä½“éªŒ */
            -webkit-user-select: none;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            width: 100vw;
            height: 100vh;
            overflow: hidden; /* é˜²æ­¢é¡µé¢æ»šåŠ¨ */
            position: relative;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        #toolbar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 999px;
            display: flex;
            gap: 15px;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            z-index: 99999;
        }

        h1 {
            font-size: 18px;
            font-weight: bold;
            margin-right: 10px;
        }

        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover {
            background: #4338ca;
        }

        button.secondary {
            background: #475569;
        }

        button.secondary:hover {
            background: #334155;
        }

        /* é’¢ç´çª—å£ */
        .piano-window {
            position: absolute;
            background: var(--window-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            width: fit-content;
            min-width: 300px;
            touch-action: none; /* é˜²æ­¢è§¦æ‘¸æ»šåŠ¨ */
        }

        /* çª—å£æ ‡é¢˜æ  */
        .window-header {
            height: 40px;
            background: var(--header-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            cursor: move;
            transition: background 0.2s;
        }

        .window-header.dragging {
            background: var(--header-bg-dragging);
        }

        .window-title {
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .window-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-btn {
            background: transparent;
            color: #94a3b8;
            padding: 4px;
            font-size: 16px;
            line-height: 1;
        }

        .close-btn:hover {
            color: #ef4444;
            background: transparent;
        }

        /* ç¼©æ”¾æ»‘å— */
        .scale-control {
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(0,0,0,0.2);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .scale-control span {
            font-size: 10px;
            color: #cbd5e1;
        }

        input[type="range"] {
            width: 60px;
            height: 4px;
            cursor: pointer;
        }

        /* é”®ç›˜ä¸»ä½“åŒºåŸŸ */
        .keyboard-body {
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* å…«åº¦è°ƒèŠ‚æŒ‰é’® */
        .octave-btn-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .octave-btn {
            width: 24px;
            height: 24px;
            padding: 0;
            font-size: 16px;
            line-height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #334155;
        }

        .octave-btn:hover {
            background: #4f46e5;
        }

        /* ç´é”®å®¹å™¨ */
        .keys-container {
            background: #000;
            padding: 5px;
            border-radius: 4px;
            display: flex;
            position: relative;
            /* éšè—æ¨ªå‘æ»šåŠ¨æ¡ä½†å…è®¸å†…å®¹æ’‘å¼€ */
            overflow: visible; 
        }

        /* ç™½é”® */
        .white-key {
            background: var(--white-key);
            border: 1px solid #94a3b8;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            cursor: pointer;
            position: relative;
            z-index: 1;
            transition: background 0.05s;
        }

        .white-key.active {
            background: var(--white-key-active);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        }

        /* é”®åæ ‡è®° (ä»…Cé”®æ˜¾ç¤º) */
        .key-label {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #94a3b8;
            pointer-events: none;
        }

        /* é»‘é”® */
        .black-key {
            background: var(--black-key);
            position: absolute;
            top: 0;
            /* æ ¸å¿ƒå¸ƒå±€è¦æ±‚ï¼šé»‘é”®å±…ä¸­äºä¸¤ä¸ªç™½é”®ä¹‹é—´ */
            left: 100%;
            transform: translateX(-50%);
            z-index: 10;
            border-bottom-left-radius: 2px;
            border-bottom-right-radius: 2px;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: background 0.05s;
        }

        .black-key.active {
            background: var(--black-key-active);
            box-shadow: inset 0 0 5px rgba(255,255,255,0.2);
        }
        
        /* æç¤ºä¿¡æ¯ */
        #empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #64748b;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react/": "https://aistudiocdn.com/react@^19.2.1/"
  }
}
</script>
</head>
<body>

    <div id="toolbar">
        <h1>ç®€æ˜“é’¢ç´é”®ç›˜</h1>
        <div style="width: 1px; height: 20px; background: #475569;"></div>
        <button onclick="app.createPiano()">+ æ–°å»ºé”®ç›˜</button>
        <button class="secondary" onclick="app.resetDesktop()">é‡ç½®æ¡Œé¢</button>
        <span id="count-label" style="font-size: 12px; color: #94a3b8; margin-left: 10px;">0 ä¸ªçª—å£</span>
    </div>

    <div id="empty-state" style="display: none;">
        <p style="font-size: 20px; margin-bottom: 10px;">æš‚æ— é”®ç›˜çª—å£</p>
        <p style="font-size: 14px;">ç‚¹å‡»ä¸Šæ–¹â€œæ–°å»ºé”®ç›˜â€å¼€å§‹</p>
    </div>

    <!-- é’¢ç´çª—å£å°†è¢«æ’å…¥åˆ° body ä¸­ -->

    <script>
        // --- éŸ³é¢‘å¼•æ“ (Audio Engine) ---
        // è´Ÿè´£ç”Ÿæˆå£°éŸ³ï¼Œå¤„ç†é•¿æŒ‰å»¶éŸ³å’Œæ¾æ‰‹å³åœ
        class AudioEngine {
            constructor() {
                this.ctx = null;
                this.masterGain = null;
                this.activeOscillators = new Map(); // Map<string, {osc, gain}>
            }

            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.ctx.createGain();
                    this.masterGain.gain.value = 0.3; // æ€»éŸ³é‡
                    this.masterGain.connect(this.ctx.destination);
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            }

            getFrequency(noteName, octave) {
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const noteIndex = notes.indexOf(noteName);
                const midiNumber = (octave + 1) * 12 + noteIndex;
                return 440 * Math.pow(2, (midiNumber - 69) / 12);
            }

            startNote(id, noteName, octave) {
                this.init();
                const keyId = `${id}-${noteName}-${octave}`;

                // å¦‚æœå·²ç»åœ¨æ’­æ”¾ï¼Œå…ˆåœæ­¢ï¼ˆé¿å…é‡éŸ³ï¼‰
                if (this.activeOscillators.has(keyId)) {
                    this.stopNote(id, noteName, octave);
                }

                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = 'triangle'; // ä¸‰è§’æ³¢é€‚åˆæ¨¡æ‹Ÿç®€å•çš„åˆæˆå™¨é’¢ç´
                osc.frequency.value = this.getFrequency(noteName, octave);

                // åŒ…ç»œè®¾ç½®
                const now = this.ctx.currentTime;
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(1, now + 0.01); // å¿«é€Ÿèµ·éŸ³ (10ms)

                osc.connect(gain);
                gain.connect(this.masterGain);
                osc.start();

                this.activeOscillators.set(keyId, { osc, gain });
            }

            stopNote(id, noteName, octave) {
                if (!this.ctx) return;
                const keyId = `${id}-${noteName}-${octave}`;
                const noteObj = this.activeOscillators.get(keyId);

                if (noteObj) {
                    const { osc, gain } = noteObj;
                    const now = this.ctx.currentTime;
                    
                    // å¿«é€Ÿé‡Šæ”¾ (50ms)ï¼Œæ— æ··å“ï¼Œæ— æ‹–å°¾ï¼Œä½†é¿å…çˆ†éŸ³
                    gain.gain.cancelScheduledValues(now);
                    gain.gain.setValueAtTime(gain.gain.value, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.05);

                    osc.stop(now + 0.06);
                    
                    // æ¸…ç†
                    setTimeout(() => {
                        osc.disconnect();
                        gain.disconnect();
                    }, 100);
                    this.activeOscillators.delete(keyId);
                }
            }
        }

        const audio = new AudioEngine();

        // --- é’¢ç´çª—å£ç±» (Piano Window) ---
        class PianoWindow {
            constructor(id, name, x, y, zIndex) {
                this.id = id;
                this.name = name;
                this.x = x;
                this.y = y;
                this.zIndex = zIndex;
                
                // é»˜è®¤é…ç½®
                this.startOctave = 3;
                this.endOctave = 4;
                this.scale = 40; // ç™½é”®å®½åº¦ (px)
                
                // åˆ›å»º DOM
                this.element = this.createDOM();
                this.renderKeys();
                
                // ç»‘å®šäº‹ä»¶
                this.bindDragEvent();
            }

            createDOM() {
                const div = document.createElement('div');
                div.className = 'piano-window';
                div.id = this.id;
                div.style.left = this.x + 'px';
                div.style.top = this.y + 'px';
                div.style.zIndex = this.zIndex;

                // å†…éƒ¨ç»“æ„
                div.innerHTML = `
                    <div class="window-header">
                        <div class="window-title">ğŸ¹ ${this.name}</div>
                        <div class="window-controls">
                            <div class="scale-control" onmousedown="event.stopPropagation()">
                                <span>å¤§å°</span>
                                <input type="range" min="20" max="60" value="${this.scale}" class="scale-slider">
                            </div>
                            <button class="close-btn" title="å…³é—­">âœ•</button>
                        </div>
                    </div>
                    <div class="keyboard-body">
                        <div class="octave-btn-group">
                            <button class="octave-btn add-low" title="æ·»åŠ ä½å…«åº¦">+</button>
                            <button class="octave-btn remove-low" title="ç§»é™¤ä½å…«åº¦">-</button>
                        </div>
                        <div class="keys-container">
                            <!-- ç´é”®å°†åœ¨æ­¤å¤„ç”Ÿæˆ -->
                        </div>
                        <div class="octave-btn-group">
                            <button class="octave-btn add-high" title="æ·»åŠ é«˜å…«åº¦">+</button>
                            <button class="octave-btn remove-high" title="ç§»é™¤é«˜å…«åº¦">-</button>
                        </div>
                    </div>
                    <div style="text-align: center; font-size: 10px; color: #64748b; padding-bottom: 5px;">
                        éŸ³åŸŸ: <span class="range-label">${this.startOctave} - ${this.endOctave}</span> å…«åº¦
                    </div>
                `;

                // ç»‘å®šæŒ‰é’®äº‹ä»¶
                div.querySelector('.close-btn').onclick = (e) => {
                    e.stopPropagation();
                    app.removePiano(this.id);
                };
                
                div.querySelector('.scale-slider').oninput = (e) => {
                    this.scale = parseInt(e.target.value);
                    this.renderKeys();
                };

                div.querySelector('.add-low').onclick = () => this.updateOctave(-1, 'start');
                div.querySelector('.remove-low').onclick = () => this.updateOctave(1, 'start');
                div.querySelector('.add-high').onclick = () => this.updateOctave(1, 'end');
                div.querySelector('.remove-high').onclick = () => this.updateOctave(-1, 'end');
                
                // ç‚¹å‡»çª—å£ç½®é¡¶
                div.onmousedown = () => app.bringToFront(this.id);

                document.body.appendChild(div);
                return div;
            }

            updateOctave(delta, type) {
                if (type === 'start') {
                    const newVal = this.startOctave + delta;
                    if (newVal < 0 || newVal >= this.endOctave) return;
                    this.startOctave = newVal;
                } else {
                    const newVal = this.endOctave + delta;
                    if (newVal > 8 || newVal <= this.startOctave) return;
                    this.endOctave = newVal;
                }
                this.updateRangeLabel();
                this.renderKeys();
            }

            updateRangeLabel() {
                this.element.querySelector('.range-label').textContent = `${this.startOctave} - ${this.endOctave}`;
            }

            // æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ï¼šç”Ÿæˆç™½é”®å’Œé»‘é”®
            renderKeys() {
                const container = this.element.querySelector('.keys-container');
                container.innerHTML = ''; // æ¸…ç©º

                const notesConfig = [
                    { name: 'C', hasSharp: true },
                    { name: 'D', hasSharp: true },
                    { name: 'E', hasSharp: false },
                    { name: 'F', hasSharp: true },
                    { name: 'G', hasSharp: true },
                    { name: 'A', hasSharp: true },
                    { name: 'B', hasSharp: false },
                ];

                const whiteKeyWidth = this.scale;
                const whiteKeyHeight = this.scale * 4.5;
                const blackKeyWidth = whiteKeyWidth * 0.6;
                const blackKeyHeight = whiteKeyHeight * 0.6;

                for (let o = this.startOctave; o <= this.endOctave; o++) {
                    notesConfig.forEach(note => {
                        // 1. åˆ›å»ºç™½é”®
                        const whiteKey = document.createElement('div');
                        whiteKey.className = 'white-key';
                        whiteKey.style.width = whiteKeyWidth + 'px';
                        whiteKey.style.height = whiteKeyHeight + 'px';
                        
                        // C é”®æ ‡è®°
                        if (note.name === 'C') {
                            const label = document.createElement('span');
                            label.className = 'key-label';
                            label.textContent = 'C' + o;
                            whiteKey.appendChild(label);
                        }

                        // ç»‘å®šç™½é”®äº¤äº’
                        this.bindKeyEvents(whiteKey, note.name, o, false);
                        
                        // 2. å¦‚æœæœ‰é»‘é”® (Sharp)ï¼Œå°†å…¶ä½œä¸ºå­å…ƒç´ æŒ‚è½½åˆ°ç™½é”®ä¸Šï¼Œåˆ©ç”¨ absolute å®šä½å®ç° "å±…ä¸­äºä¸¤é”®ä¹‹é—´"
                        if (note.hasSharp) {
                            const blackKey = document.createElement('div');
                            blackKey.className = 'black-key';
                            blackKey.style.width = blackKeyWidth + 'px';
                            blackKey.style.height = blackKeyHeight + 'px';
                            // CSS ä¸­å·²ç»å®šä¹‰äº† left: 100%; transform: translateX(-50%)
                            
                            // ç»‘å®šé»‘é”®äº¤äº’
                            this.bindKeyEvents(blackKey, note.name + '#', o, true);
                            whiteKey.appendChild(blackKey);
                        }

                        container.appendChild(whiteKey);
                    });
                }
            }

            bindKeyEvents(element, noteName, octave, isBlack) {
                const start = (e) => {
                    e.stopPropagation(); // é˜²æ­¢è§¦å‘çˆ¶å…ƒç´ äº‹ä»¶
                    e.preventDefault();  // é˜²æ­¢è§¦æ‘¸å±æ»šåŠ¨
                    element.classList.add('active');
                    audio.startNote(this.id, noteName, octave);
                };

                const stop = (e) => {
                    // ä»…å½“åŒ…å« active ç±»æ—¶æ‰æ‰§è¡Œåœæ­¢é€»è¾‘ï¼Œé¿å…å¤šæ¬¡è§¦å‘
                    if (element.classList.contains('active')) {
                        element.classList.remove('active');
                        audio.stopNote(this.id, noteName, octave);
                    }
                };

                // é¼ æ ‡äº‹ä»¶
                element.onmousedown = start;
                element.onmouseup = stop;
                element.onmouseleave = stop;

                // è§¦æ‘¸äº‹ä»¶ (æ”¯æŒå¤šç‚¹è§¦æ§)
                element.ontouchstart = start;
                element.ontouchend = stop;
                element.ontouchcancel = stop;
            }

            // ä¸æ»‘æ‹–æ‹½å®ç° (ç›´æ¥æ“ä½œ DOM æ ·å¼ï¼Œä¸ç»è¿‡æ¡†æ¶çŠ¶æ€)
            bindDragEvent() {
                const header = this.element.querySelector('.window-header');
                let isDragging = false;
                let startX = 0;
                let startY = 0;
                let initialLeft = 0;
                let initialTop = 0;

                const onMouseMove = (e) => {
                    if (!isDragging) return;
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    
                    this.x = initialLeft + dx;
                    this.y = initialTop + dy;
                    
                    this.element.style.left = this.x + 'px';
                    this.element.style.top = this.y + 'px';
                };

                const onMouseUp = () => {
                    if (isDragging) {
                        isDragging = false;
                        header.classList.remove('dragging');
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    }
                };

                header.onmousedown = (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯æ§åˆ¶æŒ‰é’®ï¼Œä¸è§¦å‘æ‹–æ‹½
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
                    
                    isDragging = true;
                    header.classList.add('dragging');
                    startX = e.clientX;
                    startY = e.clientY;
                    initialLeft = this.x;
                    initialTop = this.y;
                    
                    // ç½®é¡¶
                    app.bringToFront(this.id);

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                };
            }
        }

        // --- åº”ç”¨ç¨‹åºç®¡ç†å™¨ (Main App) ---
        class App {
            constructor() {
                this.pianos = new Map(); // id -> PianoWindow
                this.maxZIndex = 100;
                this.nextPianoIndex = 1;
                this.countLabel = document.getElementById('count-label');
                this.emptyState = document.getElementById('empty-state');
            }

            init() {
                // åˆå§‹åŒ–åˆ›å»ºä¸€ä¸ª
                this.createPiano();
            }

            createPiano() {
                const id = 'piano-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
                const name = `é’¢ç´${this.nextPianoIndex++}`;
                
                // ç®€å•çš„çº§è”ä½ç½®è®¡ç®—
                const offset = (this.pianos.size * 30) % 200;
                const x = 50 + offset;
                const y = 100 + offset;
                
                const piano = new PianoWindow(id, name, x, y, ++this.maxZIndex);
                this.pianos.set(id, piano);
                this.updateUI();
            }

            removePiano(id) {
                const piano = this.pianos.get(id);
                if (piano) {
                    piano.element.remove();
                    this.pianos.delete(id);
                    this.updateUI();
                }
            }

            resetDesktop() {
                // æ¸…é™¤æ‰€æœ‰
                this.pianos.forEach(p => p.element.remove());
                this.pianos.clear();
                
                // é‡ç½®è®¡æ•°
                this.maxZIndex = 100;
                this.nextPianoIndex = 1;
                
                // åˆ›å»ºé»˜è®¤
                this.createPiano();
            }

            bringToFront(id) {
                const piano = this.pianos.get(id);
                if (piano && piano.zIndex !== this.maxZIndex) {
                    piano.zIndex = ++this.maxZIndex;
                    piano.element.style.zIndex = piano.zIndex;
                }
            }

            updateUI() {
                const count = this.pianos.size;
                this.countLabel.textContent = `${count} ä¸ªçª—å£`;
                if (count === 0) {
                    this.emptyState.style.display = 'block';
                } else {
                    this.emptyState.style.display = 'none';
                }
            }
        }

        // å¯åŠ¨åº”ç”¨
        const app = new App();
        app.init();

    </script>
</body>
</html>